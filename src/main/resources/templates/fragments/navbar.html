<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<div th:fragment="navbar">
    <header class="navbar">
        <div class="navbar-left">
            <a href="/home" class="logo">
                <img src="/assets/logo.png" alt="Film Addicted Logo">
                <div class="logo-text">
                    <span class="title">Film Addicted</span>
                    <span class="tagline">Can't take my eyes off films</span>
                </div>
            </a>
        </div>
        <!-- Search-->
        <div class="search-bar position-relative" style="width: 400px;">
            <form action="/search" method="get" class="d-flex flex-column gap-1" role="search" autocomplete="off">
                <input id="searchInput" class="form-control rounded w-100" type="search" name="q"
                       placeholder="Search..." aria-label="Search">
                <ul id="suggestionsList"
                    class="list-group bg-white shadow rounded"
                    style="z-index: 1000; max-height: 300px; overflow-y: auto; position: absolute; top: 100%; left: 0; right: 0; margin-top: 0.25rem;">
                </ul>
            </form>
        </div>


        <script>
            const input = document.getElementById("searchInput");
            const suggestionsList = document.getElementById("suggestionsList");

            input.addEventListener("input", async () => {
                let query = input.value.trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                suggestionsList.innerHTML = "";

                if (query.length < 1) return;

                try {
                    const response = await fetch(`/api/suggestions?q=${encodeURIComponent(query)}`);
                    const suggestions = await response.json();

                    suggestions.forEach(item => {
                        const li = document.createElement("li");
                        li.className = "list-group-item list-group-item-action d-flex align-items-center";
                        li.style.cursor = "pointer";

                        const img = document.createElement("img");
                        img.src = item.poster || "/assets/placeholder.jpg";
                        img.alt = item.title;
                        img.style.width = "40px";
                        img.style.height = "60px";
                        img.style.objectFit = "cover";
                        img.className = "me-2 rounded";

                        const span = document.createElement("span");
                        span.textContent = item.title;

                        li.appendChild(img);
                        li.appendChild(span);

                        li.onclick = () => {
                            input.value = item.title;
                            suggestionsList.innerHTML = "";
                            input.form.submit(); // Submit on click
                        };

                        suggestionsList.appendChild(li);
                    });
                } catch (e) {
                    console.error("Suggestion fetch failed", e);
                }
            });

            document.addEventListener("click", (e) => {
                if (!input.contains(e.target) && !suggestionsList.contains(e.target)) {
                    suggestionsList.innerHTML = "";
                }
            });
        </script>


        <nav class="navbar-menu">
            <a href="/movies">Movies</a>
            <a href="/series">Series</a>
            <a href="/genres">Genres</a>
            <a href="/lastestrelease">Latest Release</a>
        </nav>
        <div class="d-flex align-items-center gap-2" style="margin-left: 10px;">
            <button id="musicToggle" class="btn btn-outline-light">üéµ Play Music</button>
            <button id="nextSong" class="btn btn-outline-light">‚è≠Ô∏è</button>
            <audio id="audioPlayer" autoplay hidden></audio>
        </div>

        <script>
            const musicTracks = [
                "/assets/music/song1.mp3",
                "/assets/music/song2.mp3",
                "/assets/music/song3.mp3",
                "/assets/music/song4.mp3",
                "/assets/music/song5.mp3",
                "/assets/music/song6.mp3"
            ];

            const audioPlayer = document.getElementById("audioPlayer");
            const musicButton = document.getElementById("musicToggle");
            const nextButton = document.getElementById("nextSong");

            let currentTrack = parseInt(localStorage.getItem("currentTrackIndex") || "0", 10);
            let isPlaying = false;

            if (currentTrack >= musicTracks.length) {
                currentTrack = 0;
            }

            audioPlayer.src = musicTracks[currentTrack];

            function playNextTrack() {
                currentTrack = (currentTrack + 1) % musicTracks.length;
                localStorage.setItem("currentTrackIndex", currentTrack.toString());
                audioPlayer.src = musicTracks[currentTrack];
                if (isPlaying) {
                    audioPlayer.play();
                }
            }

            audioPlayer.addEventListener("ended", playNextTrack);

            musicButton.addEventListener("click", () => {
                if (!isPlaying) {
                    isPlaying = true;
                    audioPlayer.play();
                    musicButton.textContent = "‚è∏Ô∏è Pause Music";
                } else {
                    isPlaying = false;
                    audioPlayer.pause();
                    musicButton.textContent = "üéµ Play Music";
                }
            });

            nextButton.addEventListener("click", () => {
                playNextTrack();
                if (!isPlaying) {
                    isPlaying = true;
                    musicButton.textContent = "‚è∏Ô∏è Pause Music";
                }
            });
        </script>


        <div class="auth-buttons">
            <span th:if="${user != null and user.username != null}" style="margin-right: 10px; color: #fff;">
                    Welcome, <b th:text="${user.username}"></b>
            </span>

            <a th:if="${user != null and user.username != null}" href="/profile" class="profile-link"
               style="margin-right: 10px;">
                <img th:if="${user.avatar != null}" th:src="@{${user.avatar}}" class="profile-icon" alt="Profile"/>
                <img th:if="${user.avatar == null}"
                     src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR-tuRFyRupR6eIMCFvaXBnVWJ9x9ghHyZ1IQ&s"
                     class="profile-icon" alt="Profile"/>
            </a>

            <a th:if="${user != null and user.username != null}" href="/logout" class="btn logout">Logout</a>
            <a th:if="${user == null or user.username == null}" href="/login" class="btn login">Login</a>

        </div>
    </header>
</div>
</html>
