<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${media.title != null and media.title != '' ? media.title : 'Create New Media'}">Title</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" type="image/png" href="/assets/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-2" th:insert="~{fragments/admin_sidebar :: admin_sidebar}"></div>
        <div class="col">
            <form th:action="@{${isUpdate} ? '/admin/medias/update' : '/admin/medias/create'}" th:object="${media}"
                  method="post" enctype="multipart/form-data">
                <input th:if="${isUpdate}" type="hidden" th:field="*{id}">
                <div class="row" style="border-bottom: 1px solid #333; padding-bottom: 15px;">
                    <div class="col-6" style="padding-right: 20px;">
                        <div class="row" style="padding-bottom: 15px;">
                            <div class="col-8">
                                <label for="title">Title</label>
                                <input class="form-control" id="title" th:field="*{title}" required>
                            </div>
                        </div>
                        <div class="row" style="padding-bottom: 15px;">
                            <div class="col">
                                <label for="language">Language</label>
                                <select class="form-control" id="language" th:field="*{language}" required>
                                    <option value="English">English</option>
                                    <option value="Chinese">Chinese</option>
                                    <option value="Korean">Korean</option>
                                    <option value="Japanese">Japanese</option>
                                    <option value="Spanish">Spanish</option>
                                    <option value="Vietnamese">Vietnamese</option>
                                </select>
                            </div>
                            <div class="col">
                                <label for="year">Release year</label>
                                <input class="form-control" id="year" th:field="*{releaseYear}" required
                                       oninput="validateDigits(this)">
                            </div>
                            <div class="col">
                                <label for="type">Type</label>
                                <select class="form-control" id="type" th:field="*{type}" required>
                                    <option value="Movie">Movie</option>
                                    <option value="TV Show">Tv Show</option>
                                </select>
                            </div>
                        </div>
                        <div class="row" style="padding-bottom: 15px;">
                            <label>Genres</label>
                            <div class="d-flex flex-wrap">
                                <span
                                    th:each="genre : ${genres}"
                                    th:text="${genre.name}"
                                    class="btn mb-2 me-2 badge"
                                    th:classappend="${isUpdate and media.genres!=null and media.genres.contains(genre) ? 'bg-primary' : 'bg-secondary'}"
                                    th:attr="data-genre-id=${genre.id}"
                                    onclick="toggleGenre(this)">
                                </span>
                                <div id="genreInputsContainer"></div>
                            </div>
                        </div>
                        <div class="row" style="padding-bottom: 15px;">
                            <div class="col-2">
                                <label for="bannerUrl">Banner</label>
                            </div>
                            <div class="col">
                                <div class="row">
                                    <div class="col-3">
                                        <select class="form-control" id="bannerType" onchange="toggleBanner()">
                                            <option value="url">Enter url</option>
                                            <option value="file">Choose file</option>
                                        </select>
                                    </div>
                                    <div class="col">
                                        <input type="file" id="bannerFile" name="bannerFile" class="form-control"
                                               accept="image/*" onchange="updateBanner('file')" style="display: none">
                                        <input id="bannerUrl" name="bannerUrl" class="form-control" th:value="${media.banner}"
                                               oninput="updateBanner('url')" placeholder="https image link here">
                                    </div>
                                </div>
                            </div>
                            <img id="banner" th:src="*{banner}" width="100%">
                        </div>
                        <div class="row" style="padding-bottom: 15px;">
                            <div class="col-2">
                                <label for="video">Video</label>
                            </div>
                            <div class="col">
                                <input class="form-control" th:field="*{videoUrl}" oninput="updateVideo()"
                                       placeholder="embedded https video link here">
                            </div>
                            <div style="aspect-ratio: 16/9; width: 100%">
                                <iframe id="video" th:src="*{videoUrl}" width="100%" height="100%"
                                        style="display: block" allowfullscreen></iframe>
                            </div>
                        </div>
                    </div>
                    <div class="col" style="padding-left: 20px;">
                        <div class="mb-3">
                            <label for="description">Description</label>
                            <textarea class="form-control" id="description" th:field="*{description}"></textarea>
                        </div>
                        <div class="row" style="padding-bottom: 15px;">
                            <div class="col-2">
                                <label for="posterUrl">Poster</label>
                            </div>
                            <div class="col">
                                <div class="row">
                                    <div class="col-3">
                                        <select class="form-control" id="posterType" onchange="togglePoster()">
                                            <option value="url">Enter url</option>
                                            <option value="file">Choose file</option>
                                        </select>
                                    </div>
                                    <div class="col">
                                        <input type="file" id="posterFile" name="posterFile" class="form-control"
                                               accept="image/*" onchange="updatePoster('file')" style="display: none">
                                        <input id="posterUrl" name="posterUrl" class="form-control" th:value="${media.poster}"
                                               oninput="updatePoster('url')" placeholder="https image link here">
                                    </div>
                                </div>
                            </div>
                            <img id="poster" th:src="*{poster}" width="100%">
                        </div>
                    </div>
                </div>
                <div class="row" style="padding-top: 15px; padding-bottom: 15px;">
                    <div class="col-auto">
                        <button type="submit" class="btn btn-success">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
<style>
    label{
        color: white;
    }
</style>
<script th:inline="javascript">
    let selectedGenreIds = [];
    document.addEventListener('DOMContentLoaded', function() {
        //year
        const year = document.getElementById('year');
        if(!year || (!year.value ||  year.value.trim()==='0')){
            year.value = new Date().getFullYear();
        }

        //genre
        const selectedBadges = document.querySelectorAll('.badge.bg-primary');
            selectedBadges.forEach(badge => {
                const genreId = parseInt(badge.getAttribute('data-genre-id'));
                selectedGenreIds.push(genreId);
            });

        updateGenreInputs();

        //images
        const form = document.querySelector('form');
        if(form){
            form.addEventListener('submit', function(e){
                const bannerFile = document.getElementById('bannerFile');
                const bannerUrl = document.getElementById('bannerUrl');
                if(bannerFile && bannerFile.files && bannerFile.files.length>0){
                    if(bannerUrl){
                        bannerUrl.remove();
                    }
                }
                else{
                    if(bannerFile){
                        bannerFile.remove();
                    }
                }

                const posterFile = document.getElementById('posterFile');
                const posterUrl = document.getElementById('posterUrl');
                if(posterFile && posterFile.files && posterFile.files.length>0){
                    if(posterUrl){
                        posterUrl.remove();
                    }
                }
                else{
                    if(posterFile){
                        posterFile.remove();
                    }
                }
            });
        }
    });

    function toggleGenre(element){
        const genreId = parseInt(element.getAttribute('data-genre-id'));
        if(selectedGenreIds.includes(genreId)){
            selectedGenreIds = selectedGenreIds.filter(id => id!=genreId);
            element.classList.remove('bg-primary');
            element.classList.add('bg-secondary');
        }
        else{
            selectedGenreIds.push(genreId);
            element.classList.remove('bg-secondary');
            element.classList.add('bg-primary');
        }
        updateGenreInputs();
        console.log(selectedGenreIds);
    }

    function updateGenreInputs() {
        const container = document.getElementById('genreInputsContainer');
        // Clear existing inputs
        container.innerHTML = '';

        // Create hidden input for each selected genre
        selectedGenreIds.forEach(genreId => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'genreIds';
            input.value = genreId;
            container.appendChild(input);
        });
    }

    function updateVideo(){
        const videoUrl = document.getElementById('videoUrl');
        const convertedLink = convertGGDriveLink(videoUrl.value);
        const videoPlayer = document.getElementById('video');
        if(convertedLink !== ''){
            setTimeout(() => {
                videoUrl.value = convertedLink;
                videoPlayer.src = convertedLink;
            }, 500);
        }
        else{
            videoPlayer.src = videoUrl.value;
        }
    }

    function convertGGDriveLink(rawLink){
        //Check if link is extractable
        if(!rawLink || !rawLink.includes('drive.google.com') || !rawLink.includes('/d/')){
            console.log('Invalid link');
        }
        else{
            //Extract file id from link
            const matched = rawLink.match(/\/d\/([a-zA-Z0-9_-]{25,})/);

            //Update link if extracted
            if(matched){
                const fileId = matched[1];
                console.log('Found ' + fileId);
                return "https://drive.google.com/file/d/" + fileId + "/preview";
            }
            else{
                console.log('No match');
            }
        }
        return '';
    }

    function updateBanner(source){
        const bannerUrl = document.getElementById('bannerUrl');
        const bannerFile = document.getElementById('bannerFile');
        const bannerImg = document.getElementById('banner');

        if(source === 'file'){
            const reader = new FileReader();
            reader.onload = function(e){
                bannerImg.src = e.target.result;
                bannerImg.style.display = 'block';
            };
            reader.readAsDataURL(bannerFile.files[0]);
            bannerUrl.value = '';
        }
        else if(source === 'url'){
            bannerImg.src = bannerUrl.value;
            bannerImg.style.display = 'block';
            bannerFile.value = '';
        }
        else{
            bannerImg.style.display = 'none';
        }
    }

    function updatePoster(source){
        const posterUrl = document.getElementById('posterUrl');
        const posterFile = document.getElementById('posterFile');
        const posterImg = document.getElementById('poster');

        if(source === 'file'){
            const reader = new FileReader();
            reader.onload = function(e){
                posterImg.src = e.target.result;
                posterImg.style.display = 'block';
            };
            reader.readAsDataURL(posterFile.files[0]);
            posterUrl.value = '';
        }
        else if(source === 'url'){
            posterImg.src = posterUrl.value;
            posterImg.style.display = 'block';
            posterFile.value = '';
        }
        else{
            posterImg.style.display = 'none';
        }
    }

    function toggleBanner(){
        const bannerType = document.getElementById('bannerType').value;
        const bannerUrl = document.getElementById('bannerUrl');
        const bannerFile = document.getElementById('bannerFile');
        if(bannerType === 'file'){
            bannerFile.style.display = 'block';
            bannerUrl.style.display = 'none';
            bannerUrl.value = '';
        }
        else{
            bannerUrl.style.display = 'block';
            bannerFile.style.display = 'none';
            bannerFile.value = '';
        }
    }

    function togglePoster(){
        const posterType = document.getElementById('posterType').value;
        const posterUrl = document.getElementById('posterUrl');
        const posterFile = document.getElementById('posterFile');
        if(posterType === 'file'){
            posterFile.style.display = 'block';
            posterUrl.style.display = 'none';
            posterUrl.value = '';
        }
        else{
            posterUrl.style.display = 'block';
            posterFile.style.display = 'none';
            posterFile.value = '';
        }
    }
    
    function validateDigits(input){
        input.value = input.value.replace(/\D/g, '');
    }
</script>